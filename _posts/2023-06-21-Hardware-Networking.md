Sources:
* <https://where-to-store-the-packet.readthedocs.io/en/latest/0_intro.html>
* <https://linkmeup.ru/blog/1262/> - как построить гугл
* <https://thenetworksherpa.com/tcam-in-the-forwarding-engine/>
* <https://linkmeup.ru/blog/1235/> Packet Way
* Brian Petersen Hardware-Defined Networking Kindle Edition
* <https://habr.com/ru/companies/selectel/articles/313150/>
  Для последнего десятилетия характерна тенденция к маршрутизации в софте. Для всех сетевых функций предлагаются программные альтернативы. Отсюда и DMA, DPDK, VPP, SR-IOV, которые и правда позволяют творить невиданные прежде вещи.
* <https://habr.com/ru/articles/307696/> Juniper Hardware
* <https://linkmeup.ru/podcasts/1063/> о алгоритмическом поиске



Пост является вольным конспектом этих ресурсов. Направлен на самообучение путем структурирования информации.

# Архитектура сетевых устройств
  
<img width="730" alt="Screenshot 2023-06-25 at 22 23 20" src="https://github.com/DariaShantalova/dariashantalova.github.io/assets/34622678/1c9f1710-5158-441f-bf26-4094e478fb77">

1. электрический или световой сигнал попадает через физический интерфес на устройство
2. Обрабатывается в поток битов
3. Вычленяются заголвки (парсинг - ethernet, mpls, ip и тд)
4. Traffic manager - происходит обработка, решение куда послать, полисинг, буферезация, фильтры, qos и т д
5. Происходит обратное превращение этого всего в биты
6. Отправка на физические интерфей

   3,4,5 существует благодоря control plane, на котором работают протоколы маршрутизауии

   блок задач - чип
   преобразование в биты, работа с физикой - PHY - обычно это ASIC
   CONTROL PLANE - CPU + RAM
   Parser, Traffic management, Deparser (обработка заголовков, перенаправление трафика - Packet Forwarding Manager) -
   может быть Network Processor, FPGA, cпециализированный ASIC)
   Parser - TCAM, RAM,

## Архитектрура модульных устройств
* Back Plane
* управляющий модуль
* линейная карта/интерфейсный модуль
* фабрика коммутации
  
 ### Фабрика Коммутации
 маршрутизатор операторского класса -> от 2х до десятков линейный/интерфейсхных карт -> минимум 1 FE на каждую
 Как соединить? - через транзитный элемент
 <img width="718" alt="Screenshot 2023-06-26 at 19 08 04" src="https://github.com/DariaShantalova/dariashantalova.github.io/assets/34622678/dc2432d1-c079-4268-b39c-36f9ca0e0290">
 По сути сборка тупых ASIC перенаправляющая ячейки. Часто фабрика коммутации подключены прямо в управляющий модуль.

Далее разбитие на ячейки, чтобы не было проблем по сбору.
Ячейка маленькая, расстояние одинаковое, доходит за одно время, еще и пронумерована.


##  Типы чипов
### Чипы
На сегодняшний день нет идеального варианта, поэтому для каждой цели ищется компромисс.

Чипы коммутации:
* CPU - Central Process Unit
* FPGA - Field Programmable Gate Array
* ASIC - Application Specific Integrated Cirfcuit
* NP - network processor
* Programmable ASIC

Чипы памяти:
* RAM - Random Access Memory
* CAM - Content Access Memory
* TCAM - Ternary Content Access Memory
* Алгоритмический поиск

### CPU - Central Process Unit
(+) неограниченная функциональность
(+) неограниченная гибкость
(+ -) цена
(-) производительность

идея: все реализуется программно, инструкции в оперативной памяти, для каждого пакета поход в оперативку
для изменения функционала: достаточно изменить программу
область применения: домашние роутеры, firewall, control plane в маршрутизаторах

в современных процессорах реализуется программная маршрутизация и это уже заходит в область np - network processor
но пока цены этого cpu большая и он еще будет кушать электричество

### ASIC - Application Specific Integrated Circuit
(-) ограниченная функциональность
(-) гибкость
(+) производительность
(+) цена
идея: закодировано аппаратно в транзисторах
изменения: нужно выпускать новый чип
прогонка пакета - прогонка по транзистрорам
обсласть применения: все коммутаторы, маршрутизаторы


### FPGA - Field Programmable Gate Array (плис)
(+-) функциональность
(+-) гибкость
(-) цена
(+) производительность
идея: аппаратно сделаны блоки с готовой функциональностью, можно написать программу из блоков
изменения: залитие новой прошивки (лучше чем делать новый чип, но хуже чем залитие программы
область применения: энтерпрайз


### NP - Network Processor
(+) гибкость
(+) функциональность
(+-) производительность достотачно высокая
(-) цена достаточно высокая

как cpu только для сетевых задач
несколько ядер - каждое для своего сегмента
изменения: переписать код
может в :
* циклы
* инкапсуляции
* NAT
* своп меток
* код на С

производительность хуже чем у ASIC и FPGA
используется в маршрутизаторах сети и аггрегации

### Programmable ASIC
(+) достаточная гибкость
(-) ограниченная функциональность
(+) маленькая цена
(+) очень высокая производительность


## Чипы для датацентров
* Broadcom (Jericho, Qumran etc)
* Mellanox ( Spectrum/NVIDIA)
* Intel

в датацентрах в основном все делится на edge, spine, leaf
edge: MPLS, RSVP-TE, BGP, VPN и тд
spine: молотилка трафика, может быть vxlan
leaf: Qos, ACL, Vxlan

новые чипы выпускаются регулярно, соревнуясь в производительности
так же популярным запросом стала телеметрия

## Чипы памяти
### RAM Random Access Memory
принцип - адрес ячейки значение
1. хранятся все Soft table, синхронизируются с Hard Tables, передача данных происходит через Hard Tables, так как в RAM обращение CPU долго
2. очереди, перед обработкой чипом пакет хранится в очереди
   есть несколько видов RAM, выбирают в зависимости от задач
   * SDRAM
   * DDR
   * HBM
   * GDDR5, GDDR6
   * HMC
  
### CAM - Contetnt Address Memory
принцип: значение -> хэш -> ячейка памяти в RAM (Hard Tables -> выходной интерфейс)
Сигнал идет на сравнивающие элементы одновременно, выдача значения за фиксированное время, дороже чем RAM из-за этих элементов
хэш функция:
* фиксированная длина и уменьшение значения 48 бит мак адресов в 16 бит
* для одинакового значения один результат
* все значения равновероятны
* любая длина аргумента - фиксированное значение

  пример с адресом:
  Пришёл самый первый Ethernet-кадр на порт коммутатора.
Коммутатор извлёк SMAC, вычислил его хэш.
Данный хэш он записал в сравнивающие элементы CAM, номер интерфейса откуда пришёл кадр в RAM, а в саму ячейку CAM адрес ячейки в RAM.
Выполнил рассылку изначального кадра во все порты.
Повторил пп. 1-5 ….
Заполнена вся таблица MAC-адресов.
Приходит Ethernet-кадр. Коммутатор сначала проверяет, известен ли ему данный SMAC (сравнивает хэш адреса с записанными хэшами в CAM) и, если нет, сохраняет.
Извлекает DMAC, считает его хэш.
Данный хэш он прогоняет через все сравнивающие элементы CAM и находит единственное совпадение.
Узнаёт номер порта, отправляет туда изначальный кадр.


### TCAM Ternary Content Access Memmory
значения:
* 0
* 1
* не важно
хэш функция не используется
  (-) тепловыделение (ячейки - транзисторы - греются)
  (+) производительность
  (-) цена, раньше объем определял стоимость маршрутизаторв
  (-+) объем

### Алгоритмический поиск
отдельный ASIC, реализующий поиск IP,  с ним же рядом ставится RAM
дешевле и лучше по тепловыделению


## Архитектура  сетевых ASIC

   <img width="702" alt="Screenshot 2023-06-30 at 12 57 26" src="https://github.com/DariaShantalova/dariashantalova.github.io/assets/34622678/8ac3a0b4-bed3-4395-8235-b9b19221b546">

отдельные компоненты (Ip-core) - разными производителями
например SerDes - Inphi
могут быть частью одного кристалла, напечатанного на плате
могут быть вынесены отдельно каждая
пример HBM
Juniper - 3 Asic


   

  
 
   
