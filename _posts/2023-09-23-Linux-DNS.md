# Linux DNS (To test)
[Basis DNS](https://infra.gnulinux.pro/ru/latest/infra/12/12._%D0%9E%D1%81%D0%BD%D0%BE%D0%B2%D1%8B_DNS_%D1%87.1.html)
## DNS Server configuration
1. Install bind-utils 
We are located on the mail server and we have connection to the internet.        
To check server's name command        
**hostname**          
Server's full name (with domain)             
**hostname -f**           
<img width="479" alt="Screenshot 2023-09-23 at 22 47 00" src="https://github.com/DariaShantalova/dariashantalova.github.io/assets/34622678/764f0fca-9e39-47b7-a4e1-db417faec7b5">
         
<img width="462" alt="Screenshot 2023-09-23 at 22 50 35" src="https://github.com/DariaShantalova/dariashantalova.github.io/assets/34622678/0e487437-086b-4602-be2d-3084e13317ff">

Good practise to run **yum update** before we install anything.  
Install [bind-utils](https://www.mankier.com/package/bind-utils) package for quering DNS servers.

<img width="770" alt="Screenshot 2023-09-23 at 22 53 10" src="https://github.com/DariaShantalova/dariashantalova.github.io/assets/34622678/000fd586-7976-4b0c-a990-9faf7647265e">         

2. Check DNS main configuration file **/etc/named.conf**        
To check status of the service running **system—Åtl status name_of_service**       
**systemctl status named**     
<img width="797" alt="Screenshot 2023-09-23 at 23 02 50" src="https://github.com/DariaShantalova/dariashantalova.github.io/assets/34622678/64fa986c-921a-478b-97aa-3c38a59c0ebd">

To restart service **systemctl restart named**      
To check if DNS servise is running **netstat -antp**   
-a : all    
-t TCP protocol    
-n numeric, don't use name     
-p display PID/Program name    

<img width="503" alt="Screenshot 2023-09-23 at 23 08 34" src="https://github.com/DariaShantalova/dariashantalova.github.io/assets/34622678/0d60c876-8343-4fef-b883-66a91b4614a3">      


On screen it's currently running on the loopback (port 53)      

<img width="503" alt="Screenshot 2023-09-23 at 23 08 34" src="https://github.com/DariaShantalova/dariashantalova.github.io/assets/34622678/db5b97c8-b990-45b3-94b4-18a541c7c7f1">

Activate DNS listening on the port with ip address - edit 'options' in /etc/named.conf, then restart service     

<img width="521" alt="Screenshot 2023-09-23 at 23 22 22" src="https://github.com/DariaShantalova/dariashantalova.github.io/assets/34622678/1d9dcce8-1784-418b-a67d-acaa542909a6">


3. Configure DNS ip on the windows client

<img width="724" alt="Screenshot 2023-09-23 at 23 25 21" src="https://github.com/DariaShantalova/dariashantalova.github.io/assets/34622678/84625c8d-22a3-4482-85d3-51e0a2c34fb7">


For now it doesn't work, cause only localhost is allowed to query


<img width="761" alt="Screenshot 2023-09-23 at 23 26 40" src="https://github.com/DariaShantalova/dariashantalova.github.io/assets/34622678/f9b69438-d3c0-49ba-8dec-0b33aa574b7b">

We should add there our ip subnet:     

<img width="755" alt="Screenshot 2023-09-23 at 23 28 30" src="https://github.com/DariaShantalova/dariashantalova.github.io/assets/34622678/740938ac-ecb4-4beb-b7ef-6789b5db817d">

4. And it does work       
   <img width="433" alt="Screenshot 2023-09-23 at 23 28 58" src="https://github.com/DariaShantalova/dariashantalova.github.io/assets/34622678/8524cbea-1df1-42aa-aa4a-ff18b6c5b69b">

## Primary or Master DNS server
DNS server is called Master when it holds a zone file for a particular domain.      
Zone is a portiof DNA namespace.    
It means it's authorized to answer to this domain name records.    
If we host multiple domain, then we have to create a zone file for each domain.    
We have domain mailserverguru.com. We have to create a zone file for this domain.    

Necessary concepts:
* Primary/Master DNS - dns server, that holds zone file.
* Secondary/Slave DNS - running copy of the primary dns. Primary DNS will replicate it's zone description and dns records to slave. If the primary server goes down, slave will answer all the queries.
* Zone file - file for each domain
* Forward zone - name to ip maping
* Reverse zone - ip to name maping
* 2 files: named.conf and named.localhost

  TTL 1 - means this records will be cached on the server for one day
  @in SOA - start of authority
<img width="312" alt="Screenshot 2023-09-24 at 00 40 20" src="https://github.com/DariaShantalova/dariashantalova.github.io/assets/34622678/52e8f673-d60a-4a8d-abed-13835e26df4d">


Hostname can be modified in a **/etc/hosts** file. Check with commands **hostname**, **hostname -f**, **dnsdomainname** 

<img width="626" alt="Screenshot 2023-09-24 at 00 45 39" src="https://github.com/DariaShantalova/dariashantalova.github.io/assets/34622678/36ae5ddb-ae51-443f-a399-efd0f0c7ff00">
<img width="353" alt="Screenshot 2023-09-24 at 00 47 02" src="https://github.com/DariaShantalova/dariashantalova.github.io/assets/34622678/d471b827-0bb4-418a-a4ab-4c6ecd03d5c3">

1. Add zone configurationation to the /etc/named.conf

<img width="695" alt="Screenshot 2023-09-24 at 00 50 30" src="https://github.com/DariaShantalova/dariashantalova.github.io/assets/34622678/ee82d390-dd3f-4768-89cd-0c0faecf84ba">

Interesting fact: there is default named.rfc1912.zones file
```
# cat named.rfc1912.zones
// named.rfc1912.zones:
//
// Provided by Red Hat caching-nameserver package 
//
// ISC BIND named zone configuration for zones recommended by
// RFC 1912 section 4.1 : localhost TLDs and address zones
// and http://www.ietf.org/internet-drafts/draft-ietf-dnsop-default-local-zones-02.txt
// (c)2007 R W Franks
// 
// See /usr/share/doc/bind*/sample/ for example named configuration files.
//

zone "localhost.localdomain" IN {
	type master;
	file "named.localhost";
	allow-update { none; };
};

zone "localhost" IN {
	type master;
	file "named.localhost";
	allow-update { none; };
};

zone "1.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.ip6.arpa" IN {
	type master;
	file "named.loopback";
	allow-update { none; };
};

zone "1.0.0.127.in-addr.arpa" IN {
	type master;
	file "named.loopback";
	allow-update { none; };
};

zone "0.in-addr.arpa" IN {
	type master;
	file "named.empty";
	allow-update { none; };
};
```
Also the file named.localhost in the /var directory
```
#cd /var/
# ls
adm     arpwatch  crash  empty  gopher    lib    lock  mail   nis  ossec     run    sys_basher  var  yp
agentx  cache     db     games  kerberos  local  log   named  opt  preserve  spool  tmp         www
[root@dh-mgmt-1 var]# cd named/
[root@dh-mgmt-1 named]# ls -a
.   .git_DISABLED  dynamic  named.ca    named.empty      named.loopback  named.root.hints  rev
..  data           master   named.conf  named.localhost  named.root      named.zone        slaves
[root@dh-mgmt-1 named]# cat named.localhost 
$TTL 1D
@	IN SOA	@ rname.invalid. (
					0	; serial
					1D	; refresh
					1H	; retry
					1W	; expire
					3H )	; minimum
	NS	@
	A	127.0.0.1
	AAAA	::1
[root@dh-mgmt-1 named]#
```
2. Let's copy standart name.localhost file format and edit it.    
<img width="355" alt="Screenshot 2023-09-24 at 01 01 24" src="https://github.com/DariaShantalova/dariashantalova.github.io/assets/34622678/3660322d-ccd3-48c1-9fab-c2fa3ec64fa0">


<img width="366" alt="Screenshot 2023-09-24 at 01 05 56" src="https://github.com/DariaShantalova/dariashantalova.github.io/assets/34622678/5c910ba2-cc25-4507-ae22-63fa5acc4116">      

Change the file permission:
Linux chown command is used to change a file's ownership, directory, or symbolic link for a user or group. The chown stands for change owner. In Linux, each file is associated with a corresponding owner or group.       


<img width="366" alt="Screenshot 2023-09-24 at 01 07 44" src="https://github.com/DariaShantalova/dariashantalova.github.io/assets/34622678/0fd62d06-5bd8-4606-993d-238f2c202553">

restart
**systemctl restart named**
check **netstat -antu**

<img width="421" alt="Screenshot 2023-09-24 at 01 11 21" src="https://github.com/DariaShantalova/dariashantalova.github.io/assets/34622678/2f0f6d06-db30-474d-8c24-1c859f86646b">

3. After configuring the DNS server we need to change the DNS server ip on the interface on ourself ip.
```
cd /etc/sysconfig/network-scripts/
```
<img width="421" alt="Screenshot 2023-09-24 at 01 18 00" src="https://github.com/DariaShantalova/dariashantalova.github.io/assets/34622678/a7181faa-0364-4b16-866e-4b9aa8f2cb8c">

4. For DNS query we can use **d utility** or **host utility**
```
host -a google.com
Trying "google.com"
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 39742
;; flags: qr rd ra; QUERY: 1, ANSWER: 12, AUTHORITY: 0, ADDITIONAL: 8

;; QUESTION SECTION:
;google.com.			IN	ANY

;; ANSWER SECTION:
google.com.		129	IN	A	142.251.1.101
google.com.		129	IN	A	142.251.1.102
google.com.		129	IN	A	142.251.1.139
google.com.		129	IN	A	142.251.1.138
google.com.		129	IN	A	142.251.1.100
google.com.		129	IN	A	142.251.1.113
google.com.		52515	IN	NS	ns4.google.com.
google.com.		52515	IN	NS	ns2.google.com.
google.com.		52515	IN	NS	ns1.google.com.
google.com.		52515	IN	NS	ns3.google.com.
google.com.		35	IN	SOA	ns1.google.com. dns-admin.google.com. 567836080 900 900 1800 60
google.com.		121	IN	AAAA	2a00:1450:400f:802::200e

;; ADDITIONAL SECTION:
ns4.google.com.		84511	IN	A	216.239.38.10
ns4.google.com.		31926	IN	AAAA	2001:4860:4802:38::a
ns2.google.com.		56997	IN	A	216.239.34.10
ns2.google.com.		41364	IN	AAAA	2001:4860:4802:34::a
ns1.google.com.		45844	IN	A	216.239.32.10
ns1.google.com.		36663	IN	AAAA	2001:4860:4802:32::a
ns3.google.com.		70304	IN	A	216.239.36.10
ns3.google.com.		78598	IN	AAAA	2001:4860:4802:36::a

Received 446 bytes from 10.254.1.110#53 in 215 ms
```
```
host -t ns google.com
google.com name server ns4.google.com.
google.com name server ns2.google.com.
google.com name server ns1.google.com.
google.com name server ns3.google.com.
```
<img width="643" alt="Screenshot 2023-09-24 at 01 20 55" src="https://github.com/DariaShantalova/dariashantalova.github.io/assets/34622678/9e334374-9d47-42e7-adc2-b30323869d49">



















